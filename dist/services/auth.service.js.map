{"version":3,"sources":["../../src/services/auth.service.ts"],"sourcesContent":["import { hash, compare } from 'bcrypt';\nimport { sign } from 'jsonwebtoken';\nimport { SECRET_KEY } from '@config';\nimport { CreateUserDto } from '@dtos/users.dto';\nimport { HttpException } from '@exceptions/HttpException';\nimport { DataStoredInToken, TokenData } from '@interfaces/auth.interface';\nimport { User } from '@interfaces/users.interface';\nimport userModel from '@models/users.model';\nimport { isEmpty } from '@utils/util';\n\nclass AuthService {\n  public users = userModel;\n\n  public async signup(userData: CreateUserDto): Promise<User> {\n    if (isEmpty(userData)) throw new HttpException(400, \"userData is empty\");\n\n    const findUser: User = await this.users.findOne({ email: userData.email });\n    if (findUser) throw new HttpException(409, `This email ${userData.email} already exists`);\n\n    const hashedPassword = await hash(userData.password, 10);\n    const createUserData: User = await this.users.create({ ...userData, password: hashedPassword });\n\n    return createUserData;\n  }\n\n  public async login(userData: CreateUserDto): Promise<{ cookie: string; findUser: User }> {\n    if (isEmpty(userData)) throw new HttpException(400, \"userData is empty\");\n\n    const findUser: User = await this.users.findOne({ email: userData.email });\n    if (!findUser) throw new HttpException(409, `This email ${userData.email} was not found`);\n\n    const isPasswordMatching: boolean = await compare(userData.password, findUser.password);\n    if (!isPasswordMatching) throw new HttpException(409, \"Password is not matching\");\n\n    const tokenData = this.createToken(findUser);\n    const cookie = this.createCookie(tokenData);\n\n    return { cookie, findUser };\n  }\n\n  public async logout(userData: User): Promise<User> {\n    if (isEmpty(userData)) throw new HttpException(400, \"userData is empty\");\n\n    const findUser: User = await this.users.findOne({ email: userData.email, password: userData.password });\n    if (!findUser) throw new HttpException(409, `This email ${userData.email} was not found`);\n\n    return findUser;\n  }\n\n  public createToken(user: User): TokenData {\n    const dataStoredInToken: DataStoredInToken = { _id: user._id };\n    const secretKey: string = SECRET_KEY;\n    const expiresIn: number = 60 * 60;\n\n    return { expiresIn, token: sign(dataStoredInToken, secretKey, { expiresIn }) };\n  }\n\n  public createCookie(tokenData: TokenData): string {\n    return `Authorization=${tokenData.token}; HttpOnly; Max-Age=${tokenData.expiresIn};`;\n  }\n}\n\nexport default AuthService;\n"],"names":["hash","compare","sign","SECRET_KEY","HttpException","userModel","isEmpty","AuthService","users","signup","userData","findUser","hashedPassword","createUserData","findOne","email","password","create","login","isPasswordMatching","tokenData","cookie","createToken","createCookie","logout","user","dataStoredInToken","_id","secretKey","expiresIn","token"],"mappings":"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"}